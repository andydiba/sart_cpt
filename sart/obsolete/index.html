<!DOCTYPE html>
<html lang="en-GB">
<head>
<title>SART</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">

<style>

body{background:black; color:white;}

#content{
			position:absolute;
			left:50%; top:50%;
			margin-left: -150px;  /*half-width/ half-height od 'symbols'*/
			margin-top: -150px;
					
			/*border:1px solid red;*/
}

#displayBx{
			position:relative;			
			width:300px;
			height:300px;
			line-height: 300px;
			text-align: center;
		
			font-family: Arial;
			overflow: visible;
	
			/*border:1px dotted white;*/
}

/*Fonts*/
.f0 {	font-size:48pt; }
.f1 {	font-size:72pt; }
.f2 {	font-size:94pt; }
.f3 {	font-size:100pt; }
.f4 {	font-size:120pt; }


</style>	
		
<script>

/*global config*/

var KEY = " ";
var MASK = "&#x29BB;";

/*HTML codes from:  https://www.rapidtables.com/web/html/html-codes.html*/

var SQUARE = "&#8414;";
var CIRCLE = "&#8413;";	
var DIAMOND = "&#8415;";
var TRIANGLE = "&#8420;";	
var HEART = "&#9825;";
var STAR = "&#9734;";
	var SHAPES= new Array(SQUARE, CIRCLE, DIAMOND, TRIANGLE, HEART, STAR);

var ORANGE ="&#127818;";
var TOMATO = "&#127813;";
var LEMON = "&#127819;";
var APPLE = "&#127822;";
var PEAR = "&#127824;";
var GRAPE = "&#127815;";
var CHERRY = "&#127826;";
var MELON = "&#127817;";
var PEACH = "&#127825;";
var STAWBERRY = "&#127827;";
	var FRUITS = new Array(ORANGE,TOMATO, LEMON,APPLE, PEAR, GRAPE,CHERRY,MELON,PEACH,STAWBERRY);


	var NUMBERS = new Array("1","2","3","4","5","6","7","8","9","0");
	var LETTERS = new Array("A", "h", "G","k","p", "Q","x","Y","z","S");




/*------set by server --------------------*/
var pid="a23rt9e";
var TYPE = "SART";  /*or CPT continuous performance task*/
/*----------------------------------------*/


var RUNS = 2; /*number of runs i.e. realisations of the type of test:min(RUNS) = 2 and an even number*/
var run;   	  /*current run*/
var state; 	  /*current state [ctl, exp]*/



var OMIT = new Array(ORANGE, LEMON);   //OMIT for sart, ACCEPT for CPT


/*Display geometry and timings */
var XY_SHIFT_MAX = 600;
var MASK_DURATION = 900;
var SYM_DURATION =  250;
var DEFAULT_CLR = "white";
var DEFAULT_BKG = "black";


var REPS = 2;   /*number of repetitions of symbol set per run*/

var KEY_EN;		/*KET enabled flag*/
var RT;			/*current reaction time*/
var RT0;        /*base time; for measuring delta RT*/

var displayBx;  /*display box html element*/
var hTimer;     /*handle to timer*/
var count;      /*loop counter*/
var symbols;    /*symbols array e.g. FRUITS*/
var results;    /*Overall results*/
var result;     /*result from latest 'run'*/
var sym;        /*current (sym)bol*/


var PRACTICE;


function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}



window.onload =function(){
	
	displayBx = document.getElementById('displayBx');
	
	/*load random states for each run*/    
	state = loadStates(RUNS);
		
	state = shuffle(shuffle(shuffle(state)));
	
	console.log(state);
	
	//clear results, init run
	run = 0;
	results=[];
	
	var urlp = getUrlVars();
	
	
	if(Object.entries(urlp).length === 0 )
	{   
		console.log("login page");
		
		var ans = prompt("Enter a user ID");
		while(!ans || ans.length<5)
			ans = prompt("Enter a user ID");
		
	
		window.location.assign("http://localhost:8080/index.html?p=1&x=sart&pid="+ans);
	
	}else{
		
		console.log("test page");
		console.log(urlp);
		
		TYPE = urlp.x;
		pid = urlp.pid;
		PRACTICE = urlp.p;
		
		if(PRACTICE)
		{
			REPS=2;
			document.getElementById("demo").innerHTML = "practice mode";	
		}

	
		console.log(TYPE);
	}
		
}


function reset(){
	
	/*clear result, reload and randomize symbols, reset timer/flags etc.*/
	result =[];
	
	symbols = loadSymbols(FRUITS);
	
	count = symbols.length;
	
	symbols = shuffle(shuffle(shuffle(symbols)));
	
	KEY_EN = false;
	hTimer = null;
	RT0=0;
	
	document.body.style.backgroundColor = DEFAULT_BKG; 
	displayBx.className = "f4";
	displayBx.style.left = 0;
	displayBx.style.top = 0;
	displayBx.style.color = DEFAULT_CLR;
	displayBx.innerHTML = "";
	
}


function loadStates(nruns){
	
	var dest=[];
	var i;
	
	for(i =0; i<nruns/2;i++)
	   dest.push("ctl");
	   
	for(i =nruns/2; i<nruns;i++)
	   dest.push("exp");
	
	return dest;
}

function loadSymbols(symbolFamily){
	
	var dest=[];
	var L = symbolFamily.length;
	
	for(var j=0;j<REPS;j++)
		for(var i =0; i<L;i++)
			dest.push(symbolFamily[i]);
			
	return dest;	
}

window.onkeypress = function(e){

			
	if(e.key==KEY){
		
		if(!KEY_EN && !hTimer)  /*test hasn't started yet*/
		{
			sart_start();
			console.log("starting test");
			
		}else if(KEY_EN && hTimer){ /*test is running*/
				
			KEY_EN = false;
			var now = new Date();
			RT = now.getTime()-RT0;
			
			console.log(RT);
			feedback(sym);	
		}
		
	}else if( (e.key=="q" || e.key=="Q")  && hTimer){
				
		sart_quit();
		console.log("aborting test");
	}	
			
};



function feedback(s){
	
	if( OMIT.includes(s) ) 
	{
		if(TYPE=="sart")
			displayBx.style.color = "red";
		else  //CPT
			displayBx.style.color = "green";
	
	}else{//all other symbols 
		
		if(TYPE=="sart")
			displayBx.style.color = "green";
		else  //CPT
			displayBx.style.color = "red";

	}
}


/*ajax function*/		
function loadDoc(filename) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
     //callback
     document.getElementById("demo").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", filename, true);
  xhttp.send();
}


/**
 * Shuffles array in place.
 * @param {Array} a items An array containing the items.
 */
function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}



function download(filename, text) {
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    pom.setAttribute('download', filename);

    if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
    }
    else {
        pom.click();
    }
}


function sart_start(){
	
	if(run<RUNS){
		
		reset();
		
		s = state[run];
		
		results.push({user:pid, state:s, runs:RUNS, run:run, date:new Date(),type:TYPE,omit:OMIT,reps:REPS,mask_ms:MASK_DURATION, sym_ms:SYM_DURATION});
		
		countDown(5);
    	
	}else{
		
		
		if(PRACTICE)
		{
			//go again? else do TYPE test
			//window.location.assign("http://localhost:8080/index.html?p=1&x="+TYPE+"&pid="+pid);
			//or
			//window.location.assign("http://localhost:8080/index.html?p=0&x="+TYPE+"&pid="+pid);
			
		}else{ //finished a real test
			if(TYPE=="sart")
			{
				alert("Switching to practice CPT");
				window.location.assign("http://localhost:8080/index.html?p=1&x=cpt&pid="+pid);
			
			
			}else
				alert("Testing complete. Goodbye!"); //load(reload) CPT test from here?!
		}
			
	}
	
	
}


function sart_quit(){
	
	clearTimeout(hTimer);
	hTimer = null;
	KEY_EN = false;
	
	results.pop();
	
	if(state[run]=="exp")
		loadDoc("array_off.txt");  //stop
	
	document.body.style.backgroundColor = "red"; 
	alert("Test Aborted!\n Hit [SPACE] to restart");
		
}

function setMask(){
	
	displayBx.className = "f4";
	displayBx.style.left = 0;
	displayBx.style.top = 0;
	//displayBx.style.color = DEFAULT_CLR;
	displayBx.innerHTML = "";
	displayBx.innerHTML = MASK;
	
	hTimer = setTimeout(setRandSymbol,MASK_DURATION);
		
}

function logRT(){
	if(RT0!=0){
		
		var obj ={};
		obj.sym = sym;
		obj.react_ms = RT; //RT=0 => no repsonse
		
		result.push(obj);		
	}	
}

function setRandSymbol(){

	if(count>0){
		
		logRT();  //logs previous [RT , sym]
				
		var now = new Date();
		RT0 = now.getTime();
		RT = 0;

		//pop random number from array and assign to current symbol -> 'sym'
		sym = symbols.pop();

		var rd1 =  Math.random();
		var rd2 =  Math.random();

		//Randomize Font and Position
		var font = "f"+(Math.floor(5*rd1)).toString();  //[0,4]

		var pos_x = ((rd1-0.5)*XY_SHIFT_MAX).toString()+"px";
		var pos_y = ((rd2-0.5)*XY_SHIFT_MAX).toString() +"px";
		
		displayBx.className = font;
		displayBx.style.left = pos_x;
		displayBx.style.top = pos_y;
		displayBx.style.color = DEFAULT_CLR;
		
		displayBx.innerHTML = sym;


	    hTimer = setTimeout(setMask,SYM_DURATION);	
		KEY_EN = true;
		
		count--;
		
		
	}else{
		//finished this run
		clearTimeout(hTimer);
		hTimer = null;
		KEY_EN = false;
		
		if(state[run]=="exp")
			loadDoc("array_off.txt");  //stop
		
		run++;
		
		logRT();  //get last RT
		
		//log latest run in 'results'
		results.push(result);
		console.log(results);
		
		
		if(run<RUNS){
			alert("Test run complete!\nTake a minute and hit [SPACE] to begin the next one!");
		}else{		
			alert("All done!");
			download(results[0].user, JSON.stringify(results));
		}
		
	}	
		
}


function countDown(n){

	if(n==0){
		setRandSymbol();  //begins the test
		
		if(state[run]=="exp")   //start array 
			loadDoc("array_on.txt");  
		
	}else {
		displayBx.className = "f4";
		
		msg ="";
		for(var i=0;i<n;i++)
			msg+=".";

		hTimer = setTimeout(function(){countDown(n-1);},1000);
		displayBx.innerHTML=msg;
	}

}


	
</script>
</head>
<body>
<div id='content'>
	<div id='displayBx'> </div>
</div>
<div id="demo"></div>
</body>
</html>
